<!DOCTYPE html>
<html>
<head>
  <title>–¢—Ä–µ–Ω–∏–Ω–≥–∏</title>
  <meta charset="utf-8">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">üéì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤</h1>
    
    <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
    <div id="adminPanel" class="bg-white p-4 rounded mb-4 hidden">
      <h2 class="text-xl mb-2">üîê –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
        <input id="title" placeholder="–¢–µ–º–∞ —Ç—Ä–µ–Ω–∏–Ω–≥–∞" class="border p-2">
        <input id="date" type="datetime-local" class="border p-2">
        <input id="group" placeholder="–ì—Ä—É–ø–ø–∞" class="border p-2">
        <textarea id="desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="border p-2"></textarea>
      </div>
      <button onclick="addTraining()" class="bg-blue-500 text-white px-4 py-2 rounded">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏–Ω–≥
      </button>
    </div>
    
    <!-- –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∞ -->
    <div id="adminLogin" class="bg-white p-4 rounded mb-4">
      <h2 class="text-xl mb-2">üîê –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
      <input id="adminPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="border p-2 mr-2">
      <button onclick="adminLogin()" class="bg-gray-500 text-white px-4 py-2 rounded">
        –í–æ–π—Ç–∏
      </button>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤ -->
    <div id="trainingsList"></div>
    
    <!-- –ù–µ—Ç —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤ -->
    <div id="noTrainings" class="text-center text-gray-500 py-8 hidden">
      –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤
    </div>
  </div>

  <script>
    // –¢–í–û–ô URL –û–¢ GAS
    const API_URL = 'https://script.google.com/macros/s/AKfycbwzkMypfUUVfHjM2Cx0W4mzYQlUI3pjdmQzLbz5CJQijRYfQLDiyWWQk-YgfadL8m_Z/exec';
    
    let isAdmin = false;
    
    // –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∞
    function adminLogin() {
      const pass = document.getElementById('adminPass').value;
      if (pass === 'admin123') {
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminPanel').classList.remove('hidden');
        isAdmin = true;
      } else {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤
    async function loadTrainings() {
      try {
        const response = await fetch(API_URL + '?action=getTrainings');
        const trainings = await response.json();
        
        const container = document.getElementById('trainingsList');
        const noTrainings = document.getElementById('noTrainings');
        
        if (!trainings || trainings.length === 0) {
          container.innerHTML = '';
          noTrainings.classList.remove('hidden');
          return;
        }
        
        noTrainings.classList.add('hidden');
        let html = '';
        
        trainings.forEach(t => {
          const date = new Date(t.date).toLocaleString('ru-RU', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          const participantsList = t.participants && t.participants.length > 0
            ? t.participants.map(p => `<li class="text-sm">${p}</li>`).join('')
            : '<li class="text-sm text-gray-400">–ù–∏–∫—Ç–æ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</li>';
          
          const deleteBtn = isAdmin 
            ? `<button onclick="deleteTraining('${t.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm ml-2">
                –£–¥–∞–ª–∏—Ç—å
              </button>`
            : '';
          
          html += `
            <div class="bg-white p-4 rounded shadow mb-4">
              <div class="flex justify-between items-start">
                <h3 class="text-xl font-bold">${t.title}</h3>
                ${deleteBtn}
              </div>
              <p class="text-gray-600 text-sm mt-1">üìÖ ${date} | –ì—Ä—É–ø–ø–∞: ${t.group}</p>
              <p class="mt-2">${t.desc}</p>
              <div class="mt-4">
                <button onclick="register('${t.id}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                  üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
              </div>
              <div class="mt-4">
                <p class="font-medium">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã:</p>
                <ul class="list-disc list-inside mt-1">
                  ${participantsList}
                </ul>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      }
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    async function register(trainingId) {
      const name = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:');
      if (!name) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'register',
            training_id: trainingId,
            name: name
          })
        });
        
        const result = await response.json();
        if (result.success) {
          loadTrainings();
        } else {
          alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      }
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏–Ω–≥–∞
    async function addTraining() {
      const title = document.getElementById('title').value;
      const date = document.getElementById('date').value;
      const group = document.getElementById('group').value;
      const desc = document.getElementById('desc').value;
      
      if (!title || !date) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–º—É –∏ –¥–∞—Ç—É');
        return;
      }
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'addTraining',
            id: Date.now().toString(),
            title: title,
            date: date,
            group: group,
            desc: desc
          })
        });
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('title').value = '';
          document.getElementById('date').value = '';
          document.getElementById('group').value = '';
          document.getElementById('desc').value = '';
          loadTrainings();
        } else {
          alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏–Ω–≥–∞');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏–Ω–≥–∞');
      }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏–Ω–≥–∞
    async function deleteTraining(trainingId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏–Ω–≥?')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'deleteTraining',
            id: trainingId
          })
        });
        
        const result = await response.json();
        if (result.success) {
          loadTrainings();
        } else {
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
      }
    }
    
    // –ó–∞–ø—É—Å–∫
    window.onload = function() {
      loadTrainings();
      setInterval(loadTrainings, 10000);
    };
  </script>
</body>
</html>
