<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5',
            secondary: '#06b6d4',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 font-sans">

  <!-- App Container -->
  <div id="app" class="max-w-4xl mx-auto p-4">
    <header class="text-center mb-8">
      <h1 class="text-3xl font-bold text-primary">üéì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤</h1>
      <p class="text-gray-600">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
    </header>

    <!-- Login as Admin -->
    <div id="adminLogin" class="bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">üîê –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h2>
      <input type="password" id="adminPass" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="border p-2 rounded w-full mb-2" />
      <button onclick="adminLogin()" class="bg-primary text-white px-4 py-2 rounded hover:bg-blue-700">–í–æ–π—Ç–∏</button>
    </div>

    <!-- Admin Panel (hidden by default) -->
    <div id="adminPanel" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-semibold mb-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏–Ω–≥</h2>
      <input id="title" placeholder="–¢–µ–º–∞ —Ç—Ä–µ–Ω–∏–Ω–≥–∞" class="border p-2 rounded w-full mb-2" />
      <input id="date" type="datetime-local" class="border p-2 rounded w-full mb-2" />
      <select id="group" class="border p-2 rounded w-full mb-2">
        <option value="all">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
        <option value="marketing">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</option>
        <option value="sales">–ü—Ä–æ–¥–∞–∂–∏</option>
        <option value="hr">HR</option>
      </select>
      <textarea id="desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="border p-2 rounded w-full mb-2"></textarea>
      <button onclick="addTraining()" class="bg-secondary text-white px-4 py-2 rounded hover:bg-teal-600">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <!-- Group Selector -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">üë• –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –≥—Ä—É–ø–ø—É</h2>
      <select onchange="filterByGroup(this.value)" class="border p-2 rounded w-full">
        <option value="all">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
        <option value="marketing">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</option>
        <option value="sales">–ü—Ä–æ–¥–∞–∂–∏</option>
        <option value="hr">HR</option>
      </select>
    </div>

    <!-- Trainings List -->
    <div id="trainingsList" class="space-y-4">
      <!-- Will be filled by JS -->
    </div>

    <!-- No trainings -->
    <div id="noTrainings" class="hidden text-center text-gray-500 py-8">
      –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤
    </div>
  </div>

  <script>
    // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π URL –æ—Ç Google Apps Script
    const API_URL = 'https://script.google.com/macros/s/AKfycbxezjIu_5O2nnpPEH95tM6IpQAWK7EvWaBYFBusb4kqKiyORrkMHhyMOBU5CpED91VV/exec';

    let currentUserGroup = 'all';
    let isAdmin = false;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadTrainings() {
      try {
        const res = await fetch(API_URL + '?action=getTrainings');
        const trainings = await res.json();
        renderTrainings(trainings);
        setTimeout(loadTrainings, 10000); // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫
      } catch (err) {
        console.error(err);
        setTimeout(loadTrainings, 10000);
      }
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    async function register(id) {
      const name = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
      if (!name) return;

      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'register',
          training_id: id,
          name: name
        })
      });

      loadTrainings(); // –û–±–Ω–æ–≤–∏—Ç—å
    }

    // –ê–¥–º–∏–Ω: –≤—Ö–æ–¥
    async function adminLogin() {
      const pass = document.getElementById('adminPass').value;
      if (pass !== 'admin123') {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        return;
      }

      document.getElementById('adminLogin').style.display = 'none';
      document.getElementById('adminPanel').classList.remove('hidden');
      isAdmin = true;
    }

    // –ê–¥–º–∏–Ω: –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏–Ω–≥
    async function addTraining() {
      const title = document.getElementById('title').value;
      const date = document.getElementById('date').value;
      const group = document.getElementById('group').value;
      const desc = document.getElementById('desc').value;

      if (!title || !date) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }

      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'addTraining',
          id: Date.now().toString(),
          title,
          date,
          group,
          desc
        })
      });

      document.getElementById('title').value = '';
      document.getElementById('date').value = '';
      document.getElementById('desc').value = '';

      loadTrainings();
    }

    // –ê–¥–º–∏–Ω: —É–¥–∞–ª–∏—Ç—å
    async function deleteTraining(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏–Ω–≥?')) return;
      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'deleteTraining',
          id: id
        })
      });
      loadTrainings();
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    function filterByGroup(group) {
      currentUserGroup = group;
      loadTrainings();
    }

    // –†–µ–Ω–¥–µ—Ä
    function renderTrainings(data) {
      const container = document.getElementById('trainingsList');
      const noTrainings = document.getElementById('noTrainings');
      container.innerHTML = '';

      const filtered = data.filter(t => 
        currentUserGroup === 'all' || t.group === currentUserGroup
      );

      if (filtered.length === 0) {
        noTrainings.classList.remove('hidden');
        return;
      }
      noTrainings.classList.add('hidden');

      filtered.forEach(t => {
        const date = new Date(t.date).toLocaleString('ru-RU', {
          day: '2-digit',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });

        const participantsList = t.participants?.length > 0
          ? t.participants.map(p => `<li class="text-sm text-gray-600">${p}</li>`).join('')
          : '<li class="text-sm text-gray-400">–ù–∏–∫—Ç–æ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</li>';

        const adminBtn = isAdmin 
          ? `<button onclick="deleteTraining(${t.id})" class="text-red-500 text-sm ml-2 hover:underline">–£–¥–∞–ª–∏—Ç—å</button>`
          : '';

        container.innerHTML += `
          <div class="bg-white p-5 rounded-lg shadow">
            <div class="flex justify-between items-start">
              <h3 class="text-xl font-semibold">${t.title}</h3>
              ${adminBtn}
            </div>
            <p class="text-gray-600 text-sm mt-1">üìÖ ${date} | –ì—Ä—É–ø–ø–∞: ${t.group}</p>
            <p class="mt-2">${t.desc}</p>
            <div class="mt-4">
              <button onclick="register(${t.id})" class="bg-primary text-white px-4 py-1 rounded text-sm hover:bg-blue-700">
                –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
              </button>
            </div>
            <div class="mt-4">
              <p class="text-sm font-medium">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã:</p>
              <ul class="list-disc list-inside mt-1">${participantsList}</ul>
            </div>
          </div>
        `;
      });
    }

    // –ó–∞–ø—É—Å–∫
    window.onload = () => {
      loadTrainings();
    };
  </script>
</body>
</html>
